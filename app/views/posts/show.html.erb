<div class="container mt-4">
  <% if flash[:alert] %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <%= flash[:alert] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>
  
  <% if flash[:notice] %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= flash[:notice] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>

  <div class="card">
    <div class="card-body">
      <h1 class="card-title"><%= @post.title %></h1>

      <div class="mb-3 text-muted">
        <small>
          Автор: 
          <% if @post.user %>
            <%= @post.user.name.present? ? @post.user.name : @post.user.email %>
          <% else %>
            Неизвестный автор
          <% end %>
          | 
          <%= l(@post.created_at, format: :long) %>
        </small>
      </div>
      
      <div class="card-text">
        <%= simple_format(@post.body) %>
      </div>

      <% if user_signed_in? && @post.user == current_user %>
        <div class="mt-4 d-flex gap-2">
          <%= link_to "Редактировать", edit_post_path(@post), class: 'btn btn-warning' %>
          <%= button_to "Удалить", post_path(@post), 
              method: :delete, 
              form: { data: { turbo_confirm: "Хотите удалить статью?" } }, 
              class: 'btn btn-danger' %>
        </div>
      <% end %>
    </div>
  </div>

  <hr class="my-4">

  <div class="mt-4">
    <h2>Все комментарии</h2>
    
    <%# Разделяем комментарии на удалённые и активные %>
    <% deleted_comments = @post.comments.where(body: "Комментарий удален!") %>
    <% active_comments = @post.comments.where.not(body: "Комментарий удален!").select(&:persisted?) %>
    
    <%# Показываем ОДНО уведомление если есть удалённые комментарии %>
    <% if deleted_comments.any? %>
      <div class="alert alert-warning mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>1 уведомление</strong>
          </div>
          <button type="button" class="btn btn-sm btn-outline-dark" data-bs-toggle="collapse" data-bs-target="#deletedComments">
            Показать
          </button>
        </div>
        
        <div class="collapse mt-2" id="deletedComments">
          <% deleted_comments.each do |comment| %>
            <div class="card mb-2 bg-light">
              <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <small class="text-muted">
                      <strong><%= comment.display_name %></strong>
                      <% if comment.created_at %>
                        | <%= l(comment.created_at, format: :short) %>
                      <% end %>
                    </small>
                  </div>
                  <span class="badge bg-secondary">Удалён</span>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
    
    <%# Показываем активные комментарии %>
    <% if active_comments.any? %>
      <% active_comments.each do |comment| %>
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                  <strong class="me-2">
                    <%= comment.display_name %>
                    <% if comment.user == @post.user %>
                      <span class="badge bg-info">Автор поста</span>
                    <% end %>
                  </strong>
                  <small class="text-muted ms-2">
                    <% if comment.created_at %>
                      <%= l(comment.created_at, format: :short) %>
                    <% else %>
                      время не указано
                    <% end %>
                  </small>
                </div>
                <p class="mb-0"><%= comment.body %></p>
              </div>
              
              <% if comment.persisted? && user_signed_in? && (comment.user == current_user || @post.user == current_user) %>
                <%= button_to "Удалить", post_comment_path(@post, comment), 
                    method: :delete, 
                    form: { data: { turbo_confirm: "Удалить комментарий?" }, class: 'd-inline' }, 
                    class: 'btn btn-sm btn-outline-danger' %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% elsif deleted_comments.empty? %>
      <div class="alert alert-info">
        Пока нет комментариев. Будьте первым!
      </div>
    <% end %>
  </div>

  <div class="mt-4">
    <h2>Добавление комментария</h2>
    
    <% if user_signed_in? %>
      <%= form_for([@post, @post.comments.build], data: { turbo: false }) do |f| %>
        <div class="mb-3">
          <%= f.label :body, "Текст комментария", class: "form-label" %><br>
          <%= f.text_area :body, class: "form-control", rows: 3, required: true %>
        </div>

        <div class="mb-3">
          <%= f.submit "Добавить", class: "btn btn-warning" %>
        </div>
      <% end %>
    <% else %>
      <div class="alert alert-info">
        <%= link_to "Войдите", new_user_session_path, class: "btn btn-primary btn-sm me-2" %>
        чтобы оставить комментарий
      </div>
    <% end %>
  </div>
</div>